import Authors, { Author } from '../../components/authors'

# Proposal Review
Github Action is responsible for checking the Guide Proposal Pull Requests. 
It checks the corresponding BuilderDAO guide proposal to find assigned reviewers and assign them to the pull request.


## Triggers

```yaml
  pull_request_review:
  pull_request_target:
    types: [opened, reopened, synchronize]
    branches:
      - 'dev'
      - 'main'
```

## Jobs
  ### get_proposal_slug:
  In this job, we get the slug of the proposal from the PR branch name. 
  The branch name is in the format of `tutorials/<slug>`. By doing Regex we get the slug.
  ```js
  const headBranch = context.payload.pull_request.head.ref
  const regex = /tutorials\/([A-z0-9]+(?:[_-][A-z0-9]+)*)/
  const slug = headBranch.match(regex)
  return slug && slug[1] || ''
  ```
  #### Output 
  Output this job is the slug of the proposal.

  ### fetch_proposal:
  In this job, we fetch the proposal from the BuilderDAO CLI tool. 
  And we are assigned as a variable to the context. The following jobs are tu
  ```bash
  builderdao proposal get -s $SLUG
  REVIEWER1=$(builderdao proposal get -s $SLUG -k reviewer1 --skip-ceramic)
  REVIEWER2=$(builderdao proposal get -s $SLUG -k reviewer2 --skip-ceramic)
  PROPOSAL_ID=$(builderdao proposal get -s $SLUG -k id --skip-ceramic)
  PROPOSAL_STATE=$(builderdao proposal get -s $SLUG -k state --skip-ceramic)
  REVIEWER1_GITHUBNAME=$(builderdao reviewer get -p $REVIEWER1 -k githubName)
  REVIEWER2_GITHUBNAME=$(builderdao reviewer get -p $REVIEWER2 -k githubName)
  ```
  ### comment:
  In this job, we comment on the PR with the metadata of the proposal.
  ![proposal pull request comment example](./proposal-guide-comment.png)

  ### check_review_status:
  In this job we are utilizing the GitHub API to check the status of the review from designated reviewers assigned by BuilderDAO.
  the [check-required-reviewer](../github_actions/check-required-reviewer) action is responsible for checking the required reviewers.
  ```yaml
    - uses: actions/checkout@v2
    - uses: ./.github/actions/check-required-reviewer
      id: reviewer1_review
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        AUTHOR: ${{needs.fetch_proposal.outputs.reviewer1_githubName}}
  ```
  after we collect the status of the reviewers we are determining the status of the proposal. 
  If both reviewers are approved, we are setting the `state` of the proposal
  ```
    - id: check_all_reviewers_approved
      env:
        ALL_REQUIRED_REVIEWERS_APPROVED: ${{steps.reviewer1_review.outputs.state == 'APPROVED' && steps.reviewer2_review.outputs.state  == 'APPROVED'}}
      run: |
        echo $ALL_REQUIRED_REVIEWERS_APPROVED
        STATUS=$([ "$ALL_REQUIRED_REVIEWERS_APPROVED" == true ] && echo "readyToPublish" || echo "writing")
        echo $STATUS
        echo "::set-output name=state::$STATUS"
  ```
  #### set_state:
  In this job, we are setting the state of the proposal in Solana Program via BuilderDAO CLI tool.
  ```
    - id: set_state
      env:
        PROPOSAL_ID: ${{ needs.fetch_proposal.outputs.proposalId }}
        TESTNET_ADMIN_KP: ${{ secrets.TESTNET_ADMIN_KP }}
        NEW_STATE: ${{ steps.check_all_reviewers_approved.outputs.state }}
      run: |
          builderdao proposal setstate $PROPOSAL_ID --state=$NEW_STATE --adminKp $TESTNET_ADMIN_KP
  ```
  #### ready_label:
  If the proposal state is ready to publish, in this step we are setting the `tutorial` and `ready_to_publish` labels to PR to give 
  visual clue for the contributors. 
  #### pending_label:
  While the proposal is in the `writing` state, we are setting the `tutorial` and `pending_review` labels to PR to give
  visual clue for the contributors.

  ### update_algolia_index:
  As the outcome of the review process the state of the proposal might change to `readyToPublish` or `writing`. 
  In this job, we are updating the Algolia index of the proposal. You could find in depth explanation of this step in algolia documentation {/* TODO: add documentation link. */}
  ```
    - id: update_algolia_index
        env:
          OBJECT_ID: ${{ steps.fetch.outputs.proposalId }}
          PROPOSAL_STATE: ${{ steps.fetch.outputs.proposalState }}
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_ACCESS_KEY: ${{ secrets.ALGOLIA_WRITE_API_KEY }}
          ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME }}
        run: |
          builderdao algolia updateIndex $OBJECT_ID --data='{"state": "$PROPOSAL_STATE"}' --appId $ALGOLIA_APP_ID --accessKey $ALGOLIA_ACCESS_KEY --indexName $ALGOLIA_INDEX_NAME
  ```
  ### request_reviews:
  This is the job where we requesting review from the designated reviewers.
  ```
      if: contains(needs.check_review_status.outputs.state, 'writing')
  ```
  We are doing this by utilizing github-script action to use Github Api. 
  ```
    uses: actions/github-script@v6
    with:
      script: |
        github.rest.pulls.requestReviewers({
          owner: context.repo.owner,
          repo: context.repo.repo,
          pull_number: ${{github.event.pull_request.number}},
          reviewers: [
            "${{needs.fetch_proposal.outputs.reviewer1_githubName}}",
            "${{needs.fetch_proposal.outputs.reviewer2_githubName}}"
          ]
        });
  ```




<Authors date="April 27th, 2022">
  <Author name="Necmttn" link="https://twitter.com/Necmttn" />
</Authors>